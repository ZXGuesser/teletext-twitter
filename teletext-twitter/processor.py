# teletext-twitter - creates pages for vbit2 teletext system
# (c) Mark Pentler 2018 (https://github.com/mpentler)
# see README.md for details on getting it running or run with -h
# text processor module

import textwrap
import re

ESCAPE = chr(27)
text_colours = {"red" : 65, "green" : 66, "yellow" : 67 , "blue" : 68, "magenta" : 69, "cyan" : 70, "white" : 71}

def tweet_remove_emojis(tweet, config):
    # remove pesky emoji characters
    
    if config["emoji_support"] == True:
        # leave supported emoji
        emoji_pattern = re.compile("[" # our unicode ranges go here. this will need frequent tweaking
                                  u"\U00002300-\U000023FF" # misc technical
                                  u"\U0001F680-\U0001F9FF" # transport & map symbols
                                  u"\U0001F1E6-\U0001F1FF" # regional indicator symbols
                                   "]+", flags=re.UNICODE)
    else:
        emoji_pattern = re.compile("[" # our unicode ranges go here. this will need frequent tweaking
                                  u"\U00002300-\U000023FF" # misc technical
                                  u"\U000024C2-\U0001F251" # enclosed characters including flags
                                  u"\U0001F300-\U0001F5FF" # symbols & pictographs
                                  u"\U0001F600-\U0001F67F" # emoticons
                                  u"\U0001F680-\U0001F9FF" # transport & map symbols
                                  u"\U0001F1E6-\U0001F1FF" # regional indicator symbols
                                   "]+", flags=re.UNICODE)
    tweet = emoji_pattern.sub(r'', tweet)
    return tweet

def tweet_remove_urls(tweet):
    # all tweets are https t.co links, so this is all we need
    url_pattern = re.compile("https://\S+")
    tweet = url_pattern.sub('<LINK>', tweet)
    return tweet

def tweet_highlight_query(tweet, query, config):
    tweet = tweet.replace((" " + query + " "),
                          (ESCAPE + chr(text_colours[config["search_highlight"]]) + query + ESCAPE + chr(text_colours[config["tweet_colour"]])))
    return tweet

def charsub(text):
    # do any substitutitons that will change the length of the text
    text = text.replace("‚Ä¶", "...")
    text = text.replace("«Ñ", "D≈Ω")
    text = text.replace("«Ö", "D≈æ")
    text = text.replace("«Ü", "d≈æ")
    text = text.replace("&lt;", "<")
    text = text.replace("&gt;", ">")
    text = text.replace("&amp;", "&")

    # map similar characters to one canonical unicode point
    text = text.replace("‚Ç¨", "‚Ç†")
    text = re.sub("[¬∑Œá·õ´‚Äß‚àô‚ãÖ‚ãÖ‚∏±‚∏≥„ÉªÍûè]","¬∑",text,flags=re.UNICODE)
    text = text.replace("‚Ä¢", "‚óè")
    text = text.replace("»ò", "≈û")
    text = text.replace("»ô", "≈ü")
    text = text.replace("‚Ñ´", "√Ö")
    text = text.replace("‚Äû", "‚Äù")
    text = text.replace("‚Äü", "‚Äú")
    text = re.sub("[‚Äí‚Äì‚Äî]","‚Äï",text,flags=re.UNICODE) # dashes to horizontal bar
    
    # emoji stuff
    text = re.sub("[üòä‚ò∫]","üôÇ",text,flags=re.UNICODE) # like slightly smiling face
    text = re.sub("[üòÅüòÉüòÑüòÜ]","üòÄ",text,flags=re.UNICODE) # like grinning face
    text = text.replace("üòù", "üòõ") # face with tongue
    text = text.replace("ü§£", "üòÇ") # rofl -> face with tears of joy
    text = text.replace("ü§ì", "üòé") # nerd -> sunglasses
    text = re.sub("[‚òπüò¶]","üôÅ",text,flags=re.UNICODE) # like slightly frowning face
    text = re.sub("[üò≠üò•]", "üò¢",text,flags=re.UNICODE) # like crying face
    text = re.sub("[ü§öüëãüñê]","‚úã",text,flags=re.UNICODE) # like raised hand
    text = re.sub("["u"\U0000FE00-\U0000FE0F]","",text,flags=re.UNICODE) # strip variation selectors
    
    return text

enhancementmapping = {
    # map to L1 replacement character, enhancement mode, enhancement data
    # these can be mapped to level 1 characters provided we are using the English language (which we always are right now)
    
    "¬£":[0x23,0,0],
    "‚Üê":[0x5b,0,0],
    "¬Ω":[0x5c,0,0],
    "‚Üí":[0x5d,0,0],
    "‚Üë":[0x5e,0,0],
    "#":[0x5F,0,0],
    "‚Äï":[0x60,0,0],
    "¬º":[0x7b,0,0],
    "‚Äñ":[0x7c,0,0],
    "¬æ":[0x7d,0,0],
    "√∑":[0x7e,0,0],
    
    # no diacritic - i.e. the Latin G0 character set
    # 0x23 character already present in English NOS
    "¬§":[0x7f,0x10,0x24],
    "[":[0x28,0x10,0x5b],
    "\\":[0x2f,0x10,0x5c],
    "]":[0x29,0x10,0x5d],
    "^":[0x20,0x10,0x5e], # don't map this to the English ‚Üë because of bug in Philips TVs
    "_":[0x20,0x10,0x5f], # don't map this to the English ‚Äï because of bug in Philips TVs
    "`":[0x27,0x10,0x60],
    "{":[0x28,0x10,0x7b],
    "|":[0x20,0x10,0x7c], # don't map this to the English ‚Äñ because of bug in Philips TVs
    "}":[0x29,0x10,0x7d],
    "~":[0x7f,0x10,0x7e],

    # grave AEIOUaeiou
    "√Ä":[0x41,0x11,0x41],"√à":[0x45,0x11,0x45],"√å":[0x49,0x11,0x49],"√í":[0x4F,0x11,0x4F],"√ô":[0x55,0x11,0x55],
    "√†":[0x61,0x11,0x61],"√®":[0x65,0x11,0x65],"√¨":[0x69,0x11,0x69],"√≤":[0x6F,0x11,0x6F],"√π":[0x75,0x11,0x75],

    # acute ACEILNORSUYZacegilnorsuyz
    "√Å":[0x41,0x12,0x41],"ƒÜ":[0x43,0x12,0x43],"√â":[0x45,0x12,0x45],"√ç":[0x49,0x12,0x49],"ƒπ":[0x4c,0x12,0x4c],"≈É":[0x4e,0x12,0x4e],"√ì":[0x4f,0x12,0x4f],"≈î":[0x52,0x12,0x52],"≈ö":[0x53,0x12,0x53],"√ö":[0x55,0x12,0x55],"√ù":[0x59,0x12,0x59],"≈π":[0x5a,0x12,0x5a],
    "√°":[0x61,0x12,0x61],"ƒá":[0x63,0x12,0x63],"√©":[0x65,0x12,0x65],"√≠":[0x69,0x12,0x69],"ƒ∫":[0x6c,0x12,0x6c],"≈Ñ":[0x6e,0x12,0x6e],"√≥":[0x6f,0x12,0x6f],"≈ï":[0x72,0x12,0x72],"≈õ":[0x73,0x12,0x73],"√∫":[0x75,0x12,0x75],"√Ω":[0x79,0x12,0x79],"≈∫":[0x7a,0x12,0x7a],

    # circumflex ACEGHIJOSUWYaceghijosuwy
    "√Ç":[0x41,0x13,0x41],"ƒà":[0x43,0x13,0x43],"√ä":[0x45,0x13,0x45],"ƒú":[0x47,0x13,0x47],"ƒ§":[0x48,0x13,0x48],"√é":[0x49,0x13,0x49],"ƒ¥":[0x4a,0x13,0x4a],"√î":[0x4f,0x13,0x4f],"≈ú":[0x53,0x13,0x53],"√õ":[0x55,0x13,0x55],"≈¥":[0x57,0x13,0x57],"√ù":[0x59,0x13,0x59],
    "√¢":[0x61,0x13,0x61],"ƒâ":[0x63,0x13,0x63],"√™":[0x65,0x13,0x65],"ƒù":[0x67,0x13,0x67],"ƒ•":[0x68,0x13,0x68],"√Æ":[0x69,0x13,0x69],"ƒµ":[0x6a,0x13,0x6a],"√¥":[0x6f,0x13,0x6f],"≈ù":[0x73,0x13,0x73],"√ª":[0x75,0x13,0x75],"≈µ":[0x77,0x13,0x77],"√Ω":[0x79,0x13,0x79],

    # tilde AINOUainou
    "√É":[0x41,0x14,0x41],"ƒ®":[0x49,0x14,0x49],"√ë":[0x4e,0x14,0x4e],"√ï":[0x4f,0x14,0x4f],"≈®":[0x55,0x14,0x55],
    "√£":[0x61,0x14,0x61],"ƒ©":[0x69,0x14,0x69],"√±":[0x6e,0x14,0x6e],"√µ":[0x6f,0x14,0x6f],"≈©":[0x75,0x14,0x75],

    # macron AEIOUaeiou
    "ƒÄ":[0x41,0x15,0x41],"ƒí":[0x45,0x15,0x45],"ƒ™":[0x49,0x15,0x49],"≈å":[0x4f,0x15,0x4f],"≈™":[0x55,0x15,0x55],
    "ƒÅ":[0x61,0x15,0x61],"ƒì":[0x65,0x15,0x65],"ƒ´":[0x69,0x15,0x69],"≈ç":[0x6f,0x15,0x6f],"≈´":[0x75,0x15,0x75],

    # breve AGUagu
    "ƒÇ":[0x41,0x16,0x41],"ƒû":[0x47,0x16,0x47],"≈¨":[0x55,0x16,0x55],
    "ƒÉ":[0x61,0x16,0x61],"ƒü":[0x67,0x16,0x67],"≈≠":[0x75,0x16,0x75],

    # dot CEGIZcegz
    "ƒä":[0x43,0x17,0x43],"ƒñ":[0x45,0x17,0x45],"ƒ†":[0x47,0x17,0x47],"ƒ∞":[0x49,0x17,0x49],"≈ª":[0x5a,0x17,0x5a],
    "ƒã":[0x63,0x17,0x63],"ƒó":[0x65,0x17,0x65],"ƒ°":[0x67,0x17,0x67],"≈º":[0x7a,0x17,0x7a],

    # diaeresis/umlaut AEIOUYaeiouy
    "√Ñ":[0x41,0x18,0x41],"√ã":[0x45,0x18,0x45],"√è":[0x49,0x18,0x49],"√ñ":[0x4f,0x18,0x4f],"√ú":[0x55,0x18,0x55],"≈∏":[0x59,0x18,0x59],
    "√§":[0x61,0x18,0x61],"√´":[0x65,0x18,0x65],"√Ø":[0x69,0x18,0x69],"√∂":[0x6f,0x18,0x6f],"√º":[0x75,0x18,0x75],"√ø":[0x79,0x18,0x79],

    # ring AUau
    "√Ö":[0x41,0x1a,0x41],"≈Æ":[0x55,0x1a,0x55],
    "√•":[0x61,0x1a,0x61],"≈Ø":[0x75,0x1a,0x75],

    # cedilla CGKLNRSTcklnrst
    "√á":[0x43,0x1b,0x43],"ƒ¢":[0x47,0x1b,0x47],"ƒ∂":[0x4b,0x1b,0x4b],"ƒª":[0x4c,0x1b,0x4c],"≈Ö":[0x4e,0x1b,0x4e],"≈ñ":[0x52,0x1b,0x52],"≈û":[0x53,0x1b,0x53],"»ö":[0x54,0x1b,0x54],
    "√ß":[0x63,0x1b,0x63],"ƒ∑":[0x6b,0x1b,0x6b],"ƒº":[0x6c,0x1b,0x6c],"≈Ü":[0x6e,0x1b,0x6e],"≈ó":[0x72,0x1b,0x72],"≈ü":[0x73,0x1b,0x73],"»õ":[0x74,0x1b,0x74],

    # double acute OUou
    "≈ê":[0x4f,0x1d,0x4f],"≈∞":[0x55,0x1d,0x55],
    "≈ë":[0x6f,0x1d,0x6f],"≈±":[0x75,0x1d,0x75],

    # ogonek AEIUaeiu
    "ƒÑ":[0x41,0x1e,0x41],"ƒò":[0x45,0x1e,0x45],"ƒÆ":[0x49,0x1e,0x49],"≈≤":[0x55,0x1e,0x55],
    "ƒÖ":[0x61,0x1e,0x61],"ƒô":[0x65,0x1e,0x65],"ƒØ":[0x69,0x1e,0x69],"≈≥":[0x75,0x1e,0x75],

    # caron/h√°ƒçek CDELNRSTZcdelnrstz
    "ƒå":[0x43,0x1f,0x43],"ƒé":[0x44,0x1f,0x44],"ƒö":[0x45,0x1f,0x45],"ƒΩ":[0x4c,0x1f,0x4c],"≈á":[0x4e,0x1f,0x4e],"≈ò":[0x52,0x1f,0x52],"≈†":[0x53,0x1f,0x53],"≈§":[0x54,0x1f,0x54],"≈Ω":[0x5a,0x1f,0x5a],
    "ƒç":[0x63,0x1f,0x63],"ƒè":[0x64,0x1f,0x64],"ƒõ":[0x65,0x1f,0x65],"ƒæ":[0x6c,0x1f,0x6c],"≈à":[0x6e,0x1f,0x6e],"≈ô":[0x72,0x1f,0x72],"≈°":[0x73,0x1f,0x73],"≈•":[0x74,0x1f,0x74],"≈æ":[0x7a,0x1f,0x7a],
    # symbols from the Latin G2 supplementary set
    "¬°":[0x21,0x0F,0x21],
    "¬¢":[0x63,0x0F,0x22],
    # 0x23 character already present in English NOS
    # 0x24 character already present in English NOS
    "¬•":[0x59,0x0F,0x25],
    # 0x26 character already present in English NOS
    "¬ß":[0x53,0x0F,0x27],
    # 0x28 already mapped from G0 set
    "‚Äò":[0x27,0x0F,0x29],
    "‚Äú":[0x22,0x0F,0x2a],
    "¬´":[0x3c,0x0F,0x2b],
    # 0x2c character already present in English NOS
    # 0x2d character already present in English NOS
    # 0x2e character already present in English NOS
    "‚Üì":[0x7f,0x0F,0x2f],
    "¬∞":[0x7f,0x0F,0x30],
    "¬±":[0x7f,0x0F,0x31],
    "¬≤":[0x7f,0x0F,0x32],
    "¬≥":[0x7f,0x0F,0x33],
    "√ó":[0x7f,0x0F,0x34],
    "¬µ":[0x7f,0x0F,0x35],
    "¬∂":[0x7f,0x0F,0x36],
    "¬∑":[0x7f,0x0F,0x37],
    # 0x38 characeter already present in English NOS
    "‚Äô":[0x27,0x0F,0x39],
    "‚Äù":[0x22,0x0F,0x3a],
    "¬ª":[0x3e,0x0F,0x3b],
    # 0x3c character already present in English NOS
    # 0x3d character already present in English NOS
    # 0x3e character already present in English NOS
    "¬ø":[0x3F,0x0F,0x3f],
    # 0x40-0x4f are the diacritic characters
    # 0x50 character already present in English NOS
    "¬π":[0x7f,0x0F,0x51],
    "¬Æ":[0x7f,0x0F,0x52],
    "¬©":[0x7f,0x0F,0x53],
    "‚Ñ¢":[0x7f,0x0F,0x54],
    "‚ô™":[0x7f,0x0F,0x55],
    "‚Ç†":[0x45,0x0F,0x56],
    "‚Ä∞":[0x7f,0x0F,0x57],
    "‚àù":[0x7f,0x0F,0x58],
    # 0x59-0x5b are reserved
    "‚Öõ":[0x7f,0x0F,0x5c],
    "‚Öú":[0x7f,0x0F,0x5d],
    "‚Öù":[0x7f,0x0F,0x5e],
    "‚Öû":[0x7f,0x0F,0x5f],
    "Œ©":[0x7f,0x0F,0x60],
    "√Ü":[0x7f,0x0F,0x61],
    "ƒê":[0x44,0x0F,0x62],
    "¬™":[0x61,0x0F,0x63],
    "ƒ¶":[0x48,0x0F,0x64],
    # 0x65 is reserved
    "ƒ≤":[0x7f,0x0F,0x66],
    "ƒø":[0x4C,0x0F,0x67],
    "≈Å":[0x4C,0x0F,0x68],
    "√ò":[0x4f,0x0F,0x69],
    "≈í":[0x7f,0x0F,0x6a],
    "¬∫":[0x6f,0x0F,0x6b],
    "√û":[0x7f,0x0F,0x6c],
    "≈¶":[0x4f,0x0F,0x6d],
    "≈ä":[0x7f,0x0F,0x6e],
    "≈â":[0x6e,0x0F,0x6f],
    "ƒ∏":[0x71,0x0F,0x70],
    "√¶":[0x7f,0x0F,0x71],
    "ƒë":[0x64,0x0F,0x72],
    "√∞":[0x64,0x0F,0x73],
    "ƒß":[0x68,0x0F,0x74],
    "ƒ±":[0x69,0x0F,0x75],
    "ƒ≥":[0x7f,0x0F,0x76],
    "≈Ä":[0x6C,0x0F,0x77],
    "≈Ç":[0x6C,0x0F,0x78],
    "√∏":[0x6f,0x0F,0x79],
    "≈ì":[0x7f,0x0F,0x7a],
    "√ü":[0x73,0x0F,0x7b],
    "√æ":[0x7f,0x0F,0x7c],
    "≈ß":[0x4f,0x0F,0x7d],
    "≈ã":[0x7f,0x0F,0x7e],
    
    # G1 mosaics
    "‚ñå":[0x7f,0x01,0x35],
    "‚ñê":[0x7f,0x01,0x6a],
    "‚ñà":[0x7f,0x01,0x7f],
    
    # G3 smooth mosaics and line drawing set
    "‚ñí":[0x7f,0x02,0x2f],
    "‚óè":[0x7f,0x02,0x4D],
    "‚¨§":[0x7f,0x02,0x4E],
    "‚óØ":[0x4f,0x02,0x4F],
    
    # emojis from custom gdrcs
    "üôÇ":[0x20,0x0D,0x00], # slightly smiling face
    "üòÄ":[0x20,0x0D,0x01], # grinning face
    "üòõ":[0x20,0x0D,0x02], # face with tongue
    "üòâ":[0x20,0x0D,0x03], # winking face
    "üòÇ":[0x20,0x0D,0x04], # face with tears of joy
    "üòé":[0x20,0x0D,0x05], # smiling face with sunglasses
    "üòú":[0x20,0x0D,0x06], # winking face with tongue
    "üòÆ":[0x20,0x0D,0x07], # face with open mouth
    "üòµ":[0x20,0x0D,0x08], # dizzy face
    "üôÅ":[0x20,0x0D,0x09], # slightly frowning face
    "üò¢":[0x20,0x0D,0x0A], # crying face
    "üíØ":[0x20,0x0D,0x0B], # hundred points
    "üëç":[0x20,0x0D,0x0C], # thumbs up
    "üëé":[0x20,0x0D,0x0D], # thumbs down
    "üëå":[0x20,0x0D,0x0E], # OK hand
    "‚úã":[0x20,0x0D,0x0F], # raised hand
    "‚ù§":[0x20,0x0D,0x10], # heavy black heart
    "üíî":[0x20,0x0D,0x11], # broken heart
    
    #todo: more mappings
}

def charenhance(text,offset):
    # replace characters in text string for the level 1 page, and return a list of enhancement triplets
    newtext = ""
    enhancements = []
    for index, char in enumerate(text):
        newchar = enhancementmapping.get(char, [ord(char),0,0])
        if newchar[0] > 127:
            newchar = [0x7F,0,0] # blank unknown unicode characters
        newtext += chr(newchar[0])
        if (newchar[1]):
            enhancements.append([index+offset,newchar[1],newchar[2]])
    return newtext,enhancements
